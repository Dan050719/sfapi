<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>SuccessFactors User Lookup</title>
  <style>
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; }
    form { display: flex; gap: 8px; align-items: center; margin-bottom: 16px; }
    input[type="text"] { padding: 8px; min-width: 280px; }
    button { padding: 8px 12px; cursor: pointer; }
    .card { border: 1px solid #ddd; border-radius: 8px; padding: 16px; max-width: 700px; }
    .row { display: grid; grid-template-columns: 180px 1fr; gap: 8px; padding: 6px 0; }
    .row:nth-child(odd) { background: #fafafa; }
    .label { color: #555; }
    .value { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
    .muted { color: #777; }
  </style>
</head>
<body>
  <h1>SuccessFactors User Lookup</h1>

  <form id="lookup-form">
    <label for="u">Username</label>
    <input id="u" name="u" type="text" placeholder="e.g., dshields_svc" required />
    <button type="submit">Search</button>
  </form>

  <div id="out"></div>

  <script>
  const form = document.getElementById('lookup-form');
  const out = document.getElementById('out');
  let lastUser = null; // cache last loaded user for edit

  function row(label, value) {
    return `
      <div class="row">
        <div class="label">${label}</div>
        <div class="value">${value ?? '<span class="muted">—</span>'}</div>
      </div>
    `;
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const username = new FormData(form).get('u').trim();
    if (!username) return;

    // Reflect the username in the URL for deep-linking
    try {
      const url = new URL(window.location.href);
      url.searchParams.set('username', username);
      history.replaceState(null, '', url);
    } catch (_) {}

    out.innerHTML = '<p class="muted">Loading…</p>';
    try {
      const r = await fetch(`/api/user?username=${encodeURIComponent(username)}`);
      const ctype = r.headers.get('content-type') || '';
      const payload = ctype.includes('application/json') ? await r.json() : { raw: await r.text() };

      if (!r.ok) {
        const details = payload?.details ?? payload?.raw ?? '';
        out.innerHTML = `
          <div class="card">
            <p>Error: ${payload?.error || 'Request failed'}</p>
            <pre class="value">${typeof details === 'string' ? details : JSON.stringify(details, null, 2)}</pre>
          </div>`;
        return;
      }

      if (!payload.found) {
        out.innerHTML = `
          <div class="card">
            <p>No user found for "${username}".</p>
            <div style="padding-top:8px"><button id="create-user-btn">Create User</button></div>
          </div>`;
        document.getElementById('create-user-btn').addEventListener('click', () => {
          out.innerHTML = `
            <div class="card">
              <form id="create-user-form">
                <div class="row"><div class="label">userId</div><div class="value"><input name="userId" type="text" value="${username}"></div></div>
                <div class="row"><div class="label">username</div><div class="value"><input name="username" type="text" value="${username}"></div></div>
                <div class="row"><div class="label">displayName</div><div class="value"><input name="displayName" type="text"></div></div>
                <div class="row"><div class="label">email</div><div class="value"><input name="email" type="email"></div></div>
                <div class="row"><div class="label">status</div><div class="value"><input name="status" type="text" placeholder="t"></div></div>
                <div class="row"><div class="label">timeZone</div><div class="value"><input name="timeZone" type="text" placeholder="US/Eastern"></div></div>
                <div class="row"><div class="label">defaultLocale</div><div class="value"><input name="defaultLocale" type="text" placeholder="en_US"></div></div>
                <div class="row"><div class="label">division</div><div class="value"><input name="division" type="text"></div></div>
                <div class="row"><div class="label">department</div><div class="value"><input name="department" type="text"></div></div>
                <div class="row"><div class="label">location</div><div class="value"><input name="location" type="text"></div></div>
                <div style="padding-top:12px; display:flex; gap:8px;">
                  <button type="submit">Create</button>
                  <button type="button" id="create-cancel">Cancel</button>
                </div>
              </form>
              <div id="create-user-msg" class="muted" style="padding-top:8px;"></div>
            </div>`;

          document.getElementById('create-cancel').addEventListener('click', () => {
            out.innerHTML = `<div class=\"card\"><p>No user found for \"${username}\".</p><div style=\"padding-top:8px\"><button id=\"create-user-btn\">Create User</button></div></div>`;
          });

          document.getElementById('create-user-form').addEventListener('submit', async (ev) => {
            ev.preventDefault();
            const fd = new FormData(ev.currentTarget);
            const payload = Object.fromEntries(fd.entries());
            const msg = document.getElementById('create-user-msg');
            msg.textContent = 'Creating…';
            try {
              const resp = await fetch('/api/user', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
              });
              const ctype = resp.headers.get('content-type') || '';
              const data = ctype.includes('application/json') ? await resp.json() : { raw: await resp.text() };
              if (!resp.ok) {
                msg.innerHTML = `Error: ${data.error || 'Create failed'}\n` + (typeof data.details === 'string' ? data.details : JSON.stringify(data.details || data.raw || '', null, 2));
                return;
              }
              // Re-query the user to render the normal view
              const r3 = await fetch(`/api/user?username=${encodeURIComponent(username)}`);
              const c3 = r3.headers.get('content-type') || '';
              const p3 = c3.includes('application/json') ? await r3.json() : { raw: await r3.text() };
              if (r3.ok && p3.found) {
                // Simulate a fresh search render by updating the input and triggering submit
                document.getElementById('u').value = username;
                form.dispatchEvent(new Event('submit'));
              } else {
                msg.textContent = 'Created, but could not reload record automatically.';
              }
            } catch (e) {
              msg.textContent = 'Unexpected error: ' + String(e);
            }
          });
        });
        return;
      }

      const u = payload.user;
      lastUser = u;
      out.innerHTML = `
        <div class="card" id="user-card">
          ${row('userId', u.userId)}
          ${row('username', u.username)}
          ${row('displayName', u.displayName)}
          ${row('email', u.email)}
          ${row('status', u.status)}
          ${row('division', u.division)}
          ${row('department', u.department)}
          ${row('location', u.location)}
          ${row('timeZone', u.timeZone)}
          ${row('defaultLocale', u.defaultLocale)}
          ${row('assignmentUUID', u.assignmentUUID)}
          ${row('lastModifiedDateTime', u.lastModifiedDateTime)}
          ${row('lastModifiedWithTZ', u.lastModifiedWithTZ)}
          <div style="padding-top:12px"><button id="edit-btn">Edit</button></div>
        </div>`;

      // Fetch and render custom score below the user card
      try {
        const r2 = await fetch(`/api/score?username=${encodeURIComponent(u.username)}`);
        const ctype2 = r2.headers.get('content-type') || '';
        const payload2 = ctype2.includes('application/json') ? await r2.json() : { raw: await r2.text() };
        if (!r2.ok) {
          const details = payload2?.details ?? payload2?.raw ?? '';
          out.innerHTML += `
            <div class="card" style="margin-top:12px;">
              <p>Error reading score</p>
              <pre class="value">${typeof details === 'string' ? details : JSON.stringify(details, null, 2)}</pre>
            </div>`;
        } else if (!payload2.found) {
          out.innerHTML += `
            <div class="card" id="score-missing" style="margin-top:12px;">
              <p>No score record found.</p>
              <div class="muted" style="padding-bottom:8px;">externalCode typically must equal the user's userId.</div>
              <div style="padding-top:8px"><button id="create-score-btn">Create Score</button></div>
            </div>`;
          document.getElementById('create-score-btn')?.addEventListener('click', () => {
            const sc = document.getElementById('score-missing');
            sc.innerHTML = `
              <form id="score-create-form">
                <div class="row"><div class="label">externalCode</div><div class="value"><input name="externalCode" type="text" value="${u.userId}"></div></div>
                <div class="row"><div class="label">externalName</div><div class="value"><input name="externalName" type="text" value=""></div></div>
                <div class="row"><div class="label">cust_Score</div><div class="value"><input name="cust_Score" type="text" value=""></div></div>
                <div class="row"><div class="label">cust_Streak</div><div class="value"><input name="cust_Streak" type="number" min="0" step="1" value=""></div></div>
                <div style="padding-top:12px; display:flex; gap:8px;">
                  <button type="submit">Create</button>
                  <button type="button" id="score-create-cancel">Cancel</button>
                </div>
              </form>
              <div id="score-create-msg" class="muted" style="padding-top:8px;"></div>
            `;
            document.getElementById('score-create-cancel').addEventListener('click', () => {
              sc.innerHTML = `<p>No score record found.</p><div style=\"padding-top:8px\"><button id=\"create-score-btn\">Create Score</button></div>`;
            });
            document.getElementById('score-create-form').addEventListener('submit', async (ev) => {
              ev.preventDefault();
              const fd = new FormData(ev.currentTarget);
              const payload = Object.fromEntries(fd.entries());
              const msg = document.getElementById('score-create-msg');
              msg.textContent = 'Creating…';
              try {
                const resp = await fetch('/api/score', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(payload)
                });
                const ctype = resp.headers.get('content-type') || '';
                const data = ctype.includes('application/json') ? await resp.json() : { raw: await resp.text() };
                if (!resp.ok) {
                  msg.innerHTML = `Error: ${data.error || 'Create failed'}\n` + (typeof data.details === 'string' ? data.details : JSON.stringify(data.details || data.raw || '', null, 2));
                  return;
                }
                // Re-fetch score to display
                const r4 = await fetch(`/api/score?username=${encodeURIComponent(u.username)}`);
                const c4 = r4.headers.get('content-type') || '';
                const p4 = c4.includes('application/json') ? await r4.json() : { raw: await r4.text() };
                if (r4.ok && p4.found) {
                  // Trigger a fresh search to rebuild the view
                  form.dispatchEvent(new Event('submit'));
                } else {
                  msg.textContent = 'Created, but could not reload score automatically.';
                }
              } catch (e) {
                msg.textContent = 'Unexpected error: ' + String(e);
              }
            });
          });
        } else {
          const s = payload2.score;
          out.innerHTML += `
            <div class="card" id="score-card" style="margin-top:12px;">
              ${row('score.externalCode', s.externalCode)}
              ${row('score.externalName', s.externalName)}
              ${row('score.cust_Score', s.score)}
              ${row('score.cust_Streak', s.streak)}
              ${row('score.mdfSystemRecordStatus', s.mdfSystemRecordStatus)}
              ${row('score.createdBy', s.createdBy)}
              ${row('score.createdDateTime', s.createdDateTime)}
              ${row('score.lastModifiedBy', s.lastModifiedBy)}
              ${row('score.lastModifiedDateTime', s.lastModifiedDateTime)}
              <div style="padding-top:12px"><button id="score-edit-btn">Edit Score</button></div>
            </div>`;

          const score = s;
          document.getElementById('score-edit-btn')?.addEventListener('click', () => {
            const card = document.getElementById('score-card');
            card.innerHTML = `
              <form id="score-edit-form">
                <div class="row"><div class="label">externalName</div><div class="value"><input name="externalName" type="text" value="${score.externalName ?? ''}"></div></div>
                <div class="row"><div class="label">cust_Score</div><div class="value"><input name="cust_Score" type="text" value="${score.score ?? ''}"></div></div>
                <div class="row"><div class="label">cust_Streak</div><div class="value"><input name="cust_Streak" type="number" min="0" step="1" value="${score.streak ?? ''}"></div></div>
                <div class="row"><div class="label">mdfSystemRecordStatus</div><div class="value"><input name="mdfSystemRecordStatus" type="text" value="${score.mdfSystemRecordStatus ?? ''}"></div></div>
                <div style="padding-top:12px; display:flex; gap:8px;">
                  <button type="submit">Save</button>
                  <button type="button" id="score-cancel-btn">Cancel</button>
                </div>
              </form>
              <div id="score-msg" class="muted" style="padding-top:8px;"></div>
            `;

            document.getElementById('score-cancel-btn').addEventListener('click', () => {
              const s = score;
              card.innerHTML = `
                ${row('score.externalCode', s.externalCode)}
                ${row('score.externalName', s.externalName)}
                ${row('score.cust_Score', s.score)}
                ${row('score.cust_Streak', s.streak)}
                ${row('score.mdfSystemRecordStatus', s.mdfSystemRecordStatus)}
                ${row('score.createdBy', s.createdBy)}
                ${row('score.createdDateTime', s.createdDateTime)}
                ${row('score.lastModifiedBy', s.lastModifiedBy)}
                ${row('score.lastModifiedDateTime', s.lastModifiedDateTime)}
                <div style=\"padding-top:12px\"><button id=\"score-edit-btn\">Edit Score</button></div>
              `;
            });

            document.getElementById('score-edit-form').addEventListener('submit', async (ev) => {
              ev.preventDefault();
              const fd = new FormData(ev.currentTarget);
              const updates = {};
              ['externalName','cust_Score','cust_Streak','mdfSystemRecordStatus'].forEach(k => {
                const val = fd.get(k);
                const current = k === 'cust_Score' ? score.score : (k === 'cust_Streak' ? score.streak : score[k]);
                if (val !== null && val !== current) updates[k] = val;
              });
              const msg = document.getElementById('score-msg');
              if (Object.keys(updates).length === 0) {
                msg.textContent = 'No changes to save.';
                return;
              }
              msg.textContent = 'Saving…';
              try {
                const resp = await fetch('/api/score', {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username: u.username, updates })
                });
                const ctype = resp.headers.get('content-type') || '';
                const data = ctype.includes('application/json') ? await resp.json() : { raw: await resp.text() };
                if (!resp.ok) {
                  msg.innerHTML = `Error: ${data.error || 'Update failed'}\n` + (typeof data.details === 'string' ? data.details : JSON.stringify(data.details || data.raw || '', null, 2));
                  return;
                }
                // Normalize local cache to keep UI in sync
                if (Object.prototype.hasOwnProperty.call(updates, 'cust_Score')) score.score = updates.cust_Score;
                if (Object.prototype.hasOwnProperty.call(updates, 'cust_Streak')) score.streak = updates.cust_Streak;
                if (Object.prototype.hasOwnProperty.call(updates, 'externalName')) score.externalName = updates.externalName;
                msg.textContent = 'Saved.';
              } catch (e) {
                msg.textContent = 'Unexpected error: ' + String(e);
              }
            });
          });
        }
      } catch (e2) {
        out.innerHTML += `<div class="card" style="margin-top:12px;"><p>Unexpected error loading score.</p><pre class="value">${String(e2)}</pre></div>`;
      }

      document.getElementById('edit-btn').addEventListener('click', () => {
        const u = lastUser;
        const card = document.getElementById('user-card');
        card.innerHTML = `
          <form id="edit-form">
            <div class="row"><div class="label">displayName</div><div class="value"><input name="displayName" type="text" value="${u.displayName ?? ''}"></div></div>
            <div class="row"><div class="label">email</div><div class="value"><input name="email" type="email" value="${u.email ?? ''}"></div></div>
            <div class="row"><div class="label">status</div><div class="value"><input name="status" type="text" value="${u.status ?? ''}"></div></div>
            <div class="row"><div class="label">division</div><div class="value"><input name="division" type="text" value="${u.division ?? ''}"></div></div>
            <div class="row"><div class="label">department</div><div class="value"><input name="department" type="text" value="${u.department ?? ''}"></div></div>
            <div class="row"><div class="label">location</div><div class="value"><input name="location" type="text" value="${u.location ?? ''}"></div></div>
            <div class="row"><div class="label">timeZone</div><div class="value"><input name="timeZone" type="text" value="${u.timeZone ?? ''}"></div></div>
            <div class="row"><div class="label">defaultLocale</div><div class="value"><input name="defaultLocale" type="text" value="${u.defaultLocale ?? ''}"></div></div>
            <div style="padding-top:12px; display:flex; gap:8px;">
              <button type="submit">Save</button>
              <button type="button" id="cancel-btn">Cancel</button>
            </div>
          </form>
          <div id="edit-msg" class="muted" style="padding-top:8px;"></div>
        `;

        document.getElementById('cancel-btn').addEventListener('click', () => {
          // Re-render read-only view by simulating the previous successful fetch flow
          out.innerHTML = '';
          const payload = { found: true, user: lastUser };
          const evt = new Event('submit');
          // Quick reuse: render as if we just fetched success
          const u = payload.user;
          out.innerHTML = `
            <div class="card" id="user-card">
              ${row('userId', u.userId)}
              ${row('username', u.username)}
              ${row('displayName', u.displayName)}
              ${row('email', u.email)}
              ${row('status', u.status)}
              ${row('division', u.division)}
              ${row('department', u.department)}
              ${row('location', u.location)}
              ${row('timeZone', u.timeZone)}
              ${row('defaultLocale', u.defaultLocale)}
              ${row('assignmentUUID', u.assignmentUUID)}
              ${row('lastModifiedDateTime', u.lastModifiedDateTime)}
              ${row('lastModifiedWithTZ', u.lastModifiedWithTZ)}
              <div style="padding-top:12px"><button id=\"edit-btn\">Edit</button></div>
            </div>`;
          document.getElementById('edit-btn').click = null;
        });

        document.getElementById('edit-form').addEventListener('submit', async (ev) => {
          ev.preventDefault();
          const fd = new FormData(ev.currentTarget);
          const updates = {};
          ['displayName','email','status','division','department','location','timeZone','defaultLocale']
            .forEach(k => {
              const val = fd.get(k);
              if (val !== null && val !== u[k]) updates[k] = val;
            });
          const msg = document.getElementById('edit-msg');
          if (Object.keys(updates).length === 0) {
            msg.textContent = 'No changes to save.';
            return;
          }
          msg.textContent = 'Saving…';
          try {
            const resp = await fetch('/api/user', {
              method: 'PUT',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ username: u.username, updates })
            });
            const ctype = resp.headers.get('content-type') || '';
            const data = ctype.includes('application/json') ? await resp.json() : { raw: await resp.text() };
            if (!resp.ok) {
              msg.innerHTML = `Error: ${data.error || 'Update failed'}\n` + (typeof data.details === 'string' ? data.details : JSON.stringify(data.details || data.raw || '', null, 2));
              return;
            }
            // Merge updates into local view
            Object.assign(lastUser, updates);
            msg.textContent = 'Saved.';
          } catch (e) {
            msg.textContent = 'Unexpected error: ' + String(e);
          }
        });
      });
    } catch (err) {
      out.innerHTML = `<div class="card"><p>Unexpected error.</p><pre class="value">${String(err)}</pre></div>`;
    }
  });

  // On load: if ?username= or ?u= is present, prefill and auto-search
  (function initFromQuery() {
    try {
      const params = new URLSearchParams(window.location.search);
      const q = (params.get('username') || params.get('u') || '').trim();
      if (q) {
        document.getElementById('u').value = q;
        if (typeof form.requestSubmit === 'function') {
          form.requestSubmit();
        } else {
          form.dispatchEvent(new Event('submit'));
        }
      }
    } catch (_) {}
  })();
  </script>
</body>
</html>
